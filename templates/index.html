<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h2 class="text-center mb-4">üë§ Qu·∫£n l√Ω ng∆∞·ªùi d√πng MongoDB</h2>

      <!-- Form th√™m ng∆∞·ªùi d√πng -->
      <div class="card p-3 mb-4">
        <h5>Th√™m ng∆∞·ªùi d√πng</h5>
        <input
          type="text"
          id="name"
          class="form-control mb-2"
          placeholder="T√™n"
        />
        <input
          type="number"
          id="age"
          class="form-control mb-2"
          placeholder="Tu·ªïi"
        />
        <input
          type="text"
          id="countrySide"
          class="form-control mb-2"
          placeholder="Qu√™ qu√°n (c√≥ th·ªÉ b·ªè tr·ªëng)"
        />
        <button class="btn btn-success" onclick="addUser()">Th√™m</button>
      </div>

      <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
      <div class="card p-3">
        <h5>Danh s√°ch ng∆∞·ªùi d√πng</h5>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>T√™n</th>
              <th>Tu·ªïi</th>
              <th>Qu√™ qu√°n</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="userTable"></tbody>
        </table>
      </div>
    </div>

    <script>
      const API = "http://127.0.0.1:5000";

      // --- L·∫•y danh s√°ch ng∆∞·ªùi d√πng ---
      async function loadUsers() {
        try {
          const res = await fetch(`${API}/list`);
          const data = await res.json();
          const table = document.getElementById("userTable");
          table.innerHTML = "";
          if (data.status === "success" && data.data.length > 0) {
            data.data.forEach((user) => {
              table.innerHTML += `
              <tr>
                <td>${user.name}</td>
                <td>${user.age}</td>
                <td>${user.countrySide || ""}</td>
                <td>
                  <button class="btn btn-warning btn-sm" onclick="updateUser('${user._id}')">S·ª≠a</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteUser('${user._id}')">X√≥a</button>
                </td>
              </tr>`;
            });
          } else {
            table.innerHTML = `<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>`;
          }
        } catch (error) {
          alert("L·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng: " + error.message);
        }
      }

      // --- Th√™m ng∆∞·ªùi d√πng ---
      async function addUser() {
        const name = document.getElementById("name").value.trim();
        const age = document.getElementById("age").value.trim();
        const countrySide = document.getElementById("countrySide").value.trim();

        if (!name || !age) {
          return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† tu·ªïi!");
        }

        try {
          const res = await fetch(`${API}/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, age, countrySide }),
          });

          const data = await res.json();

          if (!res.ok) {
            // N·∫øu API tr·∫£ l·ªói (status code 4xx, 5xx)
            return alert(data.message || "L·ªói khi th√™m ng∆∞·ªùi d√πng!");
          }

          if (data.alert) {
            alert(data.alert); // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu c√≥
          }

          // Reset form
          document.getElementById("name").value = "";
          document.getElementById("age").value = "";
          document.getElementById("countrySide").value = "";

          loadUsers();
        } catch (error) {
          alert("L·ªói khi g·ª≠i d·ªØ li·ªáu: " + error.message);
        }
      }

      // --- C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng ---
      async function updateUser(id) {
        try {
          const newName = prompt("Nh·∫≠p t√™n m·ªõi:");
          if (newName === null) return; // n·∫øu b·∫•m cancel

          const newAge = prompt("Nh·∫≠p tu·ªïi m·ªõi:");
          if (newAge === null) return;

          const newCountrySide = prompt("Nh·∫≠p qu√™ qu√°n m·ªõi (c√≥ th·ªÉ b·ªè tr·ªëng):");
          if (newCountrySide === null) return;

          // Chu·∫©n b·ªã body g·ª≠i l√™n, b·ªè nh·ªØng tr∆∞·ªùng r·ªóng (null/empty string)
          const updateData = {};
          if (newName.trim() !== "") updateData.name = newName.trim();
          if (newAge.trim() !== "") {
            if (isNaN(parseInt(newAge))) {
              return alert("Tu·ªïi ph·∫£i l√† s·ªë nguy√™n h·ª£p l·ªá!");
            }
            updateData.age = parseInt(newAge);
          }
          // Qu√™ qu√°n c√≥ th·ªÉ b·ªè tr·ªëng n√™n v·∫´n g·ª≠i
          updateData.countrySide = newCountrySide.trim();

          if (Object.keys(updateData).length === 0) {
            return alert("B·∫°n ch∆∞a nh·∫≠p th√¥ng tin ƒë·ªÉ c·∫≠p nh·∫≠t!");
          }

          const res = await fetch(`${API}/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updateData),
          });

          const data = await res.json();

          if (!res.ok) {
            return alert(data.message || "L·ªói khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng!");
          }

          alert(data.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
          loadUsers();
        } catch (error) {
          alert("L·ªói khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: " + error.message);
        }
      }

      // --- X√≥a ng∆∞·ªùi d√πng ---
      async function deleteUser(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?")) return;
        try {
          const res = await fetch(`${API}/delete/${id}`, { method: "DELETE" });
          const data = await res.json();
          if (!res.ok) {
            return alert(data.message || "L·ªói khi x√≥a ng∆∞·ªùi d√πng!");
          }
          alert(data.message || "X√≥a th√†nh c√¥ng!");
          loadUsers();
        } catch (error) {
          alert("L·ªói khi x√≥a ng∆∞·ªùi d√πng: " + error.message);
        }
      }

      // --- T·∫£i danh s√°ch khi m·ªü trang ---
      loadUsers();
    </script>
  </body>
</html>
